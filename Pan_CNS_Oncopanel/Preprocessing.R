## Data cleaning and pre-processing

## Generate master table for all samples from various data sources
setwd("C:/Users/Noah/Syncplicity Folders/Pan-CNS Oncopanel/OncDRS data/")

master.sheet <- read.csv("REQ_ID08_65337_ONCOPANEL_SPECIMEN.csv", stringsAsFactors = F)
oncomap <- read.csv("REQ_ID08_65337_ONCOMAP_MUT_RESULTS_PROFILE.csv", stringsAsFactors = F)
oncomap$na_column <- NA
cancer.diag <- read.csv("REQ_ID08_65337_CANCER_DIAGNOSIS_CAREG.csv", stringsAsFactors = F)
identifiers <- read.csv("REQ_ID08_65337_PT_INFO_STATUS_REGISTRATION.csv", stringsAsFactors = F)
master.sheet.short <- master.sheet[, c("PATIENT_ID", "SAMPLE_ACCESSION_NBR", "PRIMARY_CANCER_DIAGNOSIS", "ORIGINAL_PATH_DIAGNOSIS", 
                                       "BIOPSY_SITE", "BIOPSY_SITE_TYPE", "TUMOR_PURITY", "PANEL_VERSION", "REPORT_DT", "REPORT_COMMENT", "SNV_COUNT")]

## combine oncopanel with oncomap information
oncomap.unique <- oncomap[!duplicated(oncomap$PATIENT_ID), ]
oncomap.short <- oncomap.unique[, c("PATIENT_ID", "MOLE_SPEC_ACCESSION_NBR", "SPECIMEN_HISTOLOGY_NM", "PATH_DIAGNOSIS_NM",
                             "SPECIMEN_ANATOMIC_SITE_NM", "SPECIMEN_TYPE_NM", "na_column", "na_column", "CALENDAR_DT", "na_column", "na_column"), ]

colnames(oncomap.short) <- colnames(master.sheet.short)
oncomap.short$TUMOR_PURITY <- NA
oncomap.short$PANEL_VERSION <- 0
oncomap.short$REPORT_COMMENT <- NA
oncomap.short$SNV_COUNT <- NA

master.sheet.short <- rbind(master.sheet.short, oncomap.short)


## convert from current date format to numeric 
temp <- sapply(master.sheet.short$REPORT_DT, as.Date, "%d-%b-%y", USE.NAMES = F)

## can't use SAPPLY, simplifies format
DATE <- rep(as.Date(temp[1], origin = "1970-01-01"), length(temp))
for (i in 1:length(temp)){
    DATE[i] <- as.Date(temp[i], origin = "1970-01-01" )
}
master.sheet.short$DATE <- DATE

## marks which samples will have CNV data from oncopanel
master.sheet.short$CNV_ONC <- DATE > "2014-04-10"

## marks which patients have multiple tumors
master.sheet.short$multiple_samples <- master.sheet.short$PATIENT_ID %in% master.sheet.short[(duplicated(master.sheet.short$PATIENT_ID)),]$PATIENT_ID 

## checks which patients have multiple cancer diagnosis
cancer.diag$multiple_samples <- cancer.diag$PATIENT_ID %in% cancer.diag[(duplicated(cancer.diag$PATIENT_ID)),]$PATIENT_ID 


## import information from cancer diagnosis sheet
master.sheet.short$Cancer_Diagnosis_Detailed <- NA
for (i in 1:nrow(master.sheet.short)){
    ## copies information over from those cases present in detailed cancer diagnosis spreadsheet
    if (master.sheet.short$PATIENT_ID[i] %in% cancer.diag$PATIENT_ID){
        ## indicates duplicates exist those samples that have duplicates
        if (master.sheet.short[i, "multiple_samples"] == T | cancer.diag[cancer.diag$PATIENT_ID == master.sheet.short$PATIENT_ID[i], ]$multiple_samples[1] == T){
            master.sheet.short$Cancer_Diagnosis_Detailed[i] <- "Multiple samples"
        }else{
            master.sheet.short$Cancer_Diagnosis_Detailed[i] <- cancer.diag[cancer.diag$PATIENT_ID == master.sheet.short$PATIENT_ID[i], ]$HISTOLOGY_DESCR
        }
    }
}

master.sheet.short$MRN <- NA
for (i in 1:nrow(master.sheet.short)){
    id <- master.sheet.short$PATIENT_ID[i]
    mrn <- identifiers[identifiers$PATIENT_ID == id, ]$BWH_MRN
    master.sheet.short$MRN[i] <- mrn
}


## TODO: add code for processing aCGH data



## write cleaned up table for manual review
master.sheet.ordered <- master.sheet.short[, c("PATIENT_ID", "MRN", "SAMPLE_ACCESSION_NBR", "PRIMARY_CANCER_DIAGNOSIS", "ORIGINAL_PATH_DIAGNOSIS", 
                                               "Cancer_Diagnosis_Detailed", colnames(master.sheet.short)[6:14])]

## remove /t symbols to enable effecient writing to excel
master.sheet.ordered$REPORT_COMMENT<- sapply(1:nrow(master.sheet.ordered), function(x){gsub("\t", "", master.sheet.ordered$REPORT_COMMENT[x])})


write.table(master.sheet.ordered, "../Analysis/master.sheet.tsv", row.names = F, sep = "\t")


## second round cleaning, after manual annotation of pathology subtypes

master.sheet <- read.delim("../OncDRS data/Master_Sheet_R_Upload.txt", stringsAsFactors = F)
master.sheet <- master.sheet[, !(colnames(master.sheet) == "Cancer_grade")]

## add back block number
opanel.sheet <- read.csv("../OncDRS data/REQ_ID08_65337_ONCOPANEL_SPECIMEN.csv", stringsAsFactors = F)
opanel.sheet <- opanel.sheet[, 4:5]
master.sheet <- merge(master.sheet, opanel.sheet, "SAMPLE_ACCESSION_NBR", all.x = T)


## read in annotated version of master sheet to add meningioma/pituitary/glioma pathology information
pit.data <- read.delim("../OncDRS data/Pituitary_R_Upload.txt", stringsAsFactors = F, skip = 1)
pit.data <- pit.data[, c("Surg.Path..", "Recurrent.", "Histochemical.Expression")]
colnames(pit.data) <- c("BLOCK_ACCESSION_NBR", "Primary", "Cancer_Type_Specific")
pit.data$Primary <- !pit.data$Primary
master.sheet <- merge(master.sheet, pit.data, "BLOCK_ACCESSION_NBR", all.x = TRUE)

## because merge doesn't work when rows have different values, have to combine values for common columns, even if NA's as placeholders
master.sheet$Primary.x[!is.na(master.sheet$Primary.y)] <- master.sheet$Primary.y[!is.na(master.sheet$Primary.y)]
master.sheet$Cancer_Type_Specific.x[!is.na(master.sheet$Cancer_Type_Specific.y)] <- master.sheet$Cancer_Type_Specific.y[!is.na(master.sheet$Cancer_Type_Specific.y)]
colnames(master.sheet)[c(10,11)] <- c("Cancer_Type_Specific", "Primary")
master.sheet <- master.sheet[, -c(20, 21)]

## same thing for meningioma data
men.data <- read.delim("../OncDRS data/Meningioma_R_Upload.txt", stringsAsFactors = F)
men.data <- men.data[, c("surg_path", "primary", "tumor_subtype", "grade")]
colnames(men.data) <- c("BLOCK_ACCESSION_NBR", "Primary", "Cancer_Type_Specific", "Grade")
men.data$Primary <- men.data$Primary == TRUE
men.data$BLOCK_ACCESSION_NBR <- sapply(men.data$BLOCK_ACCESSION_NBR, function(x){gsub("(BS)([0-9])", "\\1-\\2", x)}, USE.NAMES = FALSE)
master.sheet <- merge(master.sheet, men.data, "BLOCK_ACCESSION_NBR", all.x = TRUE)

master.sheet$Primary.x[!is.na(master.sheet$Primary.y)] <- master.sheet$Primary.y[!is.na(master.sheet$Primary.y)]
master.sheet$Cancer_Type_Specific.x[!is.na(master.sheet$Cancer_Type_Specific.y)] <- master.sheet$Cancer_Type_Specific.y[!is.na(master.sheet$Cancer_Type_Specific.y)]
colnames(master.sheet)[c(10,11)] <- c("Cancer_Type_Specific", "Primary")
master.sheet <- master.sheet[, -c(20, 21)]


## same thing for glioma data
lgg.data <- read.delim("../OncDRS data/LGG_R_Upload.txt", stringsAsFactors = F)
lgg.data <- lgg.data[, c("Surg.Path", "Diagnosis..........Path.Report.", "Primary.vs.Recurrent")]
lgg.data$Grade <- as.integer(sapply(lgg.data$Diagnosis..........Path.Report., function(x){gsub("[A-z]", "", x)}, USE.NAMES = FALSE))
lgg.data$Cancer_Type_Specific <- sapply(lgg.data$Diagnosis..........Path.Report., function(x){gsub("[0-9]", "", x)}, USE.NAMES = FALSE)
lgg.data$Cancer_Type_Specific[lgg.data$Cancer_Type_Specific == "O"] <- "Oligo"
lgg.data$Cancer_Type_Specific[lgg.data$Cancer_Type_Specific == "A"] <- "Astro"
lgg.data$Cancer_Type_Specific[lgg.data$Cancer_Type_Specific == "DA"] <- "DiffuseAstro"
lgg.data$Primary <- lgg.data$Primary.vs.Recurrent == "Primary"
lgg.data <- lgg.data[, -c(2:3)]
colnames(lgg.data)[1] <- "BLOCK_ACCESSION_NBR"
master.sheet <- merge(master.sheet, lgg.data, "BLOCK_ACCESSION_NBR", all.x = TRUE)

master.sheet$Primary.x[!is.na(master.sheet$Primary.y)] <- master.sheet$Primary.y[!is.na(master.sheet$Primary.y)]
master.sheet$Cancer_Type_Specific.x[!is.na(master.sheet$Cancer_Type_Specific.y)] <- master.sheet$Cancer_Type_Specific.y[!is.na(master.sheet$Cancer_Type_Specific.y)]
master.sheet$Grade.x[!is.na(master.sheet$Grade.y)] <- master.sheet$Grade.y[!is.na(master.sheet$Grade.y)]
colnames(master.sheet)[c(10,11,20)] <- c("Cancer_Type_Specific", "Primary", "Grade")
master.sheet <- master.sheet[, -c(21, 22, 23)]
master.sheet$Grade[is.na(master.sheet$Grade)] <- ""
master.sheet$Cancer_Type_Specific[is.na(master.sheet$Cancer_Type_Specific)] <- ""
master.sheet$Primary[is.na(master.sheet$Primary)] <- ""
write.table(master.sheet, "../OncDRS data/master.sheet.tsv", row.names = F, sep = "\t")

## remove trailing block number
master.sheet$BLOCK_ACCESSION_NBR <- sapply(master.sheet$BLOCK_ACCESSION_NBR, function(x){gsub("-[A-Z][0-9]$", "", x)}, USE.NAMES = FALSE)
master.sheet$BLOCK_ACCESSION_NBR <- sapply(master.sheet$BLOCK_ACCESSION_NBR, function(x){gsub(" [A-Z][0-9]$", "", x)}, USE.NAMES = FALSE)

merged <- merge(master.sheet, pit.data, "BLOCK_ACCESSION_NBR", all.x = T)
## read in raw data 
all.mutations <- read.csv("../OncDRS data/REQ_ID08_65337_ONCOPANEL_MUTATION_RESULTS.csv", stringsAsFactors = F)

## rename to consistent gene name
all.mutations$BEST_EFF_GENE[all.mutations$BEST_EFF_GENE == "MLL"] <- "KMT2A"
all.mutations$BEST_EFF_GENE[all.mutations$BEST_EFF_GENE == "MLL2"] <- "KMT2D"

## standardizes mutation classification
all.mutations$variant_classification <- "other"
all.mutations$variant_classification[all.mutations$BEST_EFF_VARIANT_CLASS %in% c("Missense", "Missense_Mutation", "protein_altering", "coding_sequence")] <- "missense"
all.mutations$variant_classification[all.mutations$BEST_EFF_VARIANT_CLASS %in% 
                                         c("In_Frame_Ins",  "Inframe_Del",  "Inframe_Ins", "In_Frame_Del")] <- "in_frame_indel"

all.mutations$variant_classification[all.mutations$BEST_EFF_VARIANT_CLASS %in% c("Frame_Shift_Del","Frame_Shift_Ins","Frameshift")] <- "frameshift_indel"
all.mutations$variant_classification[all.mutations$BEST_EFF_VARIANT_CLASS %in% c("Splice_Acceptor", "Splice_Donor", "Splice_Region", "Splice_Site")] <- "splice_site"
all.mutations$variant_classification[all.mutations$BEST_EFF_VARIANT_CLASS %in% c("Stop_Lost", "Nonstop_Mutation", "incomplete_terminal_codon")]<- "stop_codon"
all.mutations$variant_classification[all.mutations$BEST_EFF_VARIANT_CLASS %in% c("Nonsense", "Nonsense_Mutation")] <- "nonsense"
all.mutations$variant_classification[all.mutations$BEST_EFF_VARIANT_CLASS %in% c("Translation_Start_Site", "Initiator_Codon")] <- "TSS"


all.mutations.tier1.3 <- all.mutations[all.mutations$TIER_ID < 4, ]
all.mutations.tier1.4 <- all.mutations[all.mutations$TIER_ID < 5, ]
all.cnvs <- read.csv("../OncDRS data/REQ_ID08_65337_ONCOPANEL_CNV_RESULTS.csv", stringsAsFactors = F)
all.svs <- read.csv("../OncDRS data/REQ_ID08_65337_ONCOPANEL_SV_RESULTS.csv", stringsAsFactors = F)


## read in coverage information
gene.list <- read.delim("../OncDRS data/Gene_lists.txt", stringsAsFactors = F)
not.covered <- list(gene.list$Gene[-1][!as.numeric(gene.list$OncoPanel.v1[-1])], gene.list$Gene[-1][!as.numeric(gene.list$OncoPanel.v2[-1])],
                    gene.list$Gene[-1][!as.numeric(gene.list$OncoPanel.v3[-1])])
not.covered.map <- gene.list$Gene[-1][!as.numeric(gene.list$OncoMap[-1])]

